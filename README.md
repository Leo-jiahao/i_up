# i_up
在嵌入式MCU完成部署的一种增量升级方案，使用MCU的内部flash实现。

# 1、功能分析
基于LZ77压缩算法和bsdiff，在主机端生成增量升级包，通过文件传输协议，从机端接收到文件后，通过LZ77解压缩算法和bsdiff的融合算法，实现嵌入式软件的增量升级。通过优化，在匮资源的嵌入式平台重构并实现了必要的LZ77解压缩算法和bspatch的融合算法，提高嵌入式平台在线升级的传输和存储效率。

## 1.1、 这是LZ77算法,主要功能是对数据进行无损压缩。

主要分为以下几个部分:

1. bitio.c和bitio.h:实现了对压缩包的位操作读写。主要函数有:

  - bitIO_open():打开压缩包,返回文件描述符
  - bitIO_read():从压缩包中按位读取数据

2. lz77.c和lz77.h:实现了LZ77压缩算法的解压部分。主要函数有:

  - decode():解压函数,将压缩包解压到out_addr对应的内存区域
  - readcode():从压缩包中读取一个标记(offset, length, next char)

3. 压缩包格式:

  - 头部保存历史缓冲区大小和滑动窗口大小
  - 数据部分保存(offset, length, next char)格式的压缩标记
  - offset指向历史缓冲区的位置 
  - length表示从offset位置开始的匹配长度
  - next char表示压缩标记匹配完成后接下来的一个字符

4. 解压原理:

  - 初始化历史缓冲区和滑动窗口
  - 循环读取压缩标记
  - 根据offset和length从历史缓冲区拷贝数据到滑动窗口
  - 滑动窗口和历史缓冲区向前滑动
  - 直到读取完压缩包

总体来说,这是LZ77算法常见的实现,通过滑动窗口和查找匹配的方式来达到无损压缩的目的。代码比较简洁,主要是实现了解压功能。

## 1.2、 bspatch.c和bspatch.h文件实现了bsdiff增量包的融合算法。

主要功能:

1. bspatch()函数:主要 Patch函数

  - 将old文件和patch文件比较,生成new文件
  - 通过读取patch中的控制数据(xi,yi,zi)实现增量更新
  - xi表示new文件中增加的数据块  
  - yi表示old文件需要跳过的数据块
  - zi表示new文件需要直接从old拷贝的数据块
  - 通过old + diff = new的方式生成新文件

2. 工作原理:

  - 初始化新文件空间
  - 循环读取patch中的控制块(xi,yi,zi)
  - 根据控制块匹配old和patch,生成新文件
  - xi表示在new文件增加内容
  - yi表示跳过old文件的内容
  - zi表示从old文件拷贝内容
  - 直到新文件生成完成

3. 优点:

  - 对比全量包升级,可以只对差异部分做升级
  - 减少传输数据量,加快升级速度

bspatch实现了差分升级的核心算法,和LZ77结合可以进一步压缩升级包大小,提高传输和存储效率。

## 1.3、 bsdiff.c和bsdiff.h等文件实现了bsdiff增量包的生成算法，用于生成两个版本文件的差分补丁。
主要功能:

1. bsdiff()函数:主要生成补丁文件  
 - 将old文件和new文件进行比较  
 - 生成控制数据(长度len,增量diff,额外数据extra)
 - 将控制数据及diff数据写入补丁文件
2. 支持函数:
 - split(): 将old文件按内容切分为多个区块
 - qsufsort(): 通过后缀数组对old文件内容排序
 - matchlen(): 比较new文件和old文件内容找到匹配长度
 - search(): 在old文件内容中搜索最长匹配项
 - offtout(): 将整数转换为字节序列
3. 工作流程:
 - 将old文件内容构建后缀数组  
 - 遍历new文件,在old文件中搜索最长匹配项  
 - 生成匹配项的控制数据,写入补丁文件  
 - 对不匹配部分,写入增量diff  
添加额外数据extra  
 - 重复上述过程,直到新文件遍历完毕  
4. 优点:
 - 只需要发送修改过的内容,大幅减小传输量  
 - 支持增量更新,避免全量传输时间  
总之,bsdiff实现了差分算法的核心功能,可用于文件差分升级等场景,类似LZ77压缩可配合使用来进一步减小补丁大小。  

# 2、其他
LZ77参考：https://github.com/cstdvd/lz77.git  
bsdiff参考：https://github.com/mendsley/bsdiff.git

# 3、TODO
 - [] stm32f405_platform 代码未测试
 - [] linux_platform 工程不完备，仅仅可生成差分升级包，需要增加r_boot_master部分功能，和kp_can模块，与stm32的demo配合测试。
